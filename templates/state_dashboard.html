<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1"
    />
    <meta name="description" content="" />
    <meta name="author" content="Bootstrap contributors + you" />
    <title>Dog Movement Analysis</title>

    <!-- Bootstrap CSS via CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <!-- Your custom CSS -->
    <link
      href="{{ url_for('static', filename='css/dashboard.css') }}"
      rel="stylesheet"
    />

    <meta name="theme-color" content="#712cf9" />

    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }

      .b-example-divider {
        width: 100%;
        height: 3rem;
        background-color: #0000001a;
        border: solid rgba(0, 0, 0, 0.15);
        border-width: 1px 0;
        box-shadow:
          inset 0 0.5em 1.5em #0000001a,
          inset 0 0.125em 0.5em #00000026;
      }

      .b-example-vr {
        flex-shrink: 0;
        width: 1.5rem;
        height: 100vh;
      }

      .bi {
        vertical-align: -0.125em;
        fill: currentColor;
      }

      .nav-scroller {
        position: relative;
        z-index: 2;
        height: 2.75rem;
        overflow-y: hidden;
      }

      .nav-scroller .nav {
        display: flex;
        flex-wrap: nowrap;
        padding-bottom: 1rem;
        margin-top: -1px;
        overflow-x: auto;
        text-align: center;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
      }

      /* ===== Global readability tweaks ===== */
      body {
        font-size: 1.05rem;
        background-color: #f3f4f6;
        color: #111827;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      h1,
      h2,
      h3,
      h4 {
        letter-spacing: 0.01em;
        color: #111827;
      }

      /* --- Layout & banners for viz sections --- */
      main {
        padding-top: 1.5rem;
        padding-bottom: 3rem;
      }

      .viz-section {
        padding: 1.75rem 0 2.5rem;
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 2rem;
      }

      .viz-section:last-of-type {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }

      .section-banner {
        background: #f8fafc;
        border-left: 4px solid #0d6efd;
        padding: 1rem 1.5rem;
        border-radius: 0.75rem;
        margin-bottom: 1.5rem;
      }

      .section-banner h2 {
        font-size: 1.5rem;
        margin: 0 0 0.25rem;
      }

      .section-banner p {
        margin: 0;
        color: #4b5563;
        font-size: 1rem;
      }

      .section-title {
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
        font-size: 1.25rem;
        font-weight: 600;
      }

      .chart-subtitle {
        font-size: 1.05rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
      }

      .section-divider {
        margin: 2rem 0;
        border-color: #e5e7eb;
      }

      /* --- Observable layout helpers --- */
      .observable-row {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        margin-bottom: 1.75rem;
      }

      .observable-panel {
        flex: 1 1 0;
        min-width: 320px;
        background: #ffffff;
        border-radius: 0.75rem;
        border: 1px solid #e5e7eb;
        padding: 1rem 1.25rem 1.25rem;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.06);
        overflow-x: auto;
      }

      .observable-panel > div[id^="observablehq-"] {
        margin-top: 0.25rem;
      }

      /* --- Overall dashboard layout --- */
      .dashboard-layout {
        display: block;
      }

      .content-column {
        flex: 1 1 auto;
        min-width: 0;
      }

      /* ===== Sticky filters as a thin header bar ===== */
      .filters-panel {
        position: sticky;
        top: 64px; /* under navbar */
        z-index: 5;
        width: 100%;
        max-width: 100%;
        margin-bottom: 1rem;

        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;

        padding: 0.4rem 0.9rem;
        border-radius: 999px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 2px rgba(15, 23, 42, 0.05);

        box-sizing: border-box;
      }

      .filters-panel.observable-panel {
        padding: 0.4rem 0.9rem;
        box-shadow: 0 1px 2px rgba(15, 23, 42, 0.05);
      }

      .filters-panel h4.chart-subtitle {
        margin: 0;
        font-size: 0.95rem;
        white-space: nowrap;
      }

      .filters-panel > div[id^="observablehq-"] {
        margin-top: 0;
      }

      .filters-panel select,
      .filters-panel input,
      .filters-panel button {
        font-size: 0.85rem !important;
      }

      /* ===== Partner States Network panel – reverted sizing, better colors/fonts ===== */
      .partner-panel {
        background: #f9fafb;
        border-color: #e5e7eb;
      }

      #observablehq-partnerStatesOnly-6a33d79e svg {
        background-color: #f5f5f5 !important;
      }

      #observablehq-partnerStatesOnly-6a33d79e text {
        font-size: 1rem !important;
        fill: #111827 !important;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif !important;
      }

      /* Flow map: light background too */
      #observablehq-flowMap-00c503e1 svg {
        background-color: #f5f5f5 !important;
      }
      #observablehq-flowMap-00c503e1 svg rect {
        fill: #f5f5f5 !important;
      }

      /* Tableau container at the bottom */
      #state-tableau-container {
        position: relative;
        padding: 0.75rem;
        max-width: 900px;
        margin: 0 auto;
      }
    </style>
  </head>

  <body>
    <!-- Simple dark navbar -->
    <header
      class="navbar sticky-top bg-dark flex-md-nowrap p-0 shadow"
      data-bs-theme="dark"
    >
      <a
        class="navbar-brand col-md-3 col-lg-2 me-0 px-3 fs-6 text-white"
        href="{{ url_for('home') }}"
      >
        Dog Movement Analysis
      </a>
      <div class="navbar-nav">
        <div class="nav-item text-nowrap">
          <span class="nav-link px-3 text-white">Welcome Dog Lovers</span>
        </div>
      </div>
    </header>

    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <nav
          id="sidebarMenu"
          class="col-md-3 col-lg-2 d-md-block bg-body-tertiary sidebar collapse"
        >
          <div class="position-sticky pt-3 sidebar-sticky">
            <ul class="nav flex-column">
              <li class="nav-item">
                <p class="px-3 small text-muted">
                  Explore how dogs move between states and shelters using the
                  following dashboards.
                </p>
                <a
                  class="nav-link {% if active_page == 'state' %}active{% endif %}"
                  aria-current="page"
                  href="{{ url_for('state_dashboard') }}"
                >
                  State Representative Dashboard
                </a>
              </li>
              <li class="nav-item">
                <a
                  class="nav-link {% if active_page == 'shelter' %}active{% endif %}"
                  href="{{ url_for('shelter_dashboard') }}"
                >
                  Animal Shelter Dashboard
                </a>
              </li>
            </ul>
          </div>
        </nav>

        <!-- Main content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
          <div
            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 border-bottom"
          >
            <h1 class="h2 mb-0">State Representative Dashboard</h1>
          </div>

          <!-- Overview -->
          <section class="viz-section">
            <div class="page-header">
              <h2>Overview</h2>
              <p>
                The charts below provide information about rescue dog movement
                in the United States. Demographics and shelter organization
                visualizations will be generated based on your selections.
              </p>
              <p>
                Use the filters and visualizations below to explore how dogs
                move into, out of, and within each state. Compare partner
                networks, demographic patterns, and in-state organization
                activity.
              </p>
            </div>

            <p class="lead mb-0">
              Start by picking a flow direction and state. The panels on the
              right will update as you scroll to show complementary views of the
              same movement patterns. Try finding your state!
            </p>
          </section>

          <!-- State-level analysis -->
          <section class="viz-section">
            <div class="section-banner">
              <h2>State-Level Analysis</h2>
              <p>
                Choose ‘into state’ if you are interested in seeing where dogs
                are coming from, or choose ‘out of state’ to see where they are
                going. Then select the state you are interested in from the
                drop-down list. The dog movement across states, out-of-state
                demographics, and in-shelter activity will update based on your
                selections.
              </p>
            </div>

            <div class="dashboard-layout">
              <div class="content-column">
                <!-- Sticky filter header -->
                <aside class="observable-panel filters-panel">
                  <h4 class="chart-subtitle mb-0">State Filters</h4>
                  <div id="observablehq-viewof-flowMode-6a33d79e"></div>
                  <div id="observablehq-viewof-state-6a33d79e"></div>
                </aside>

                <!-- State-level flows -->
                <h3 class="section-title">Dog Movement Across States</h3>
                <div class="observable-row">
                  <div class="observable-panel">
                    <h4 class="chart-subtitle">Flow Map</h4>
                    <div id="observablehq-flowMap-00c503e1"></div>
                  </div>
                  <div class="observable-panel partner-panel">
                    <h4 class="chart-subtitle">Partner States Network</h4>
                    <div id="observablehq-partnerStatesOnly-6a33d79e"></div>
                  </div>
                </div>

                <!-- Out-of-state demographics -->
                <h3 class="section-title">Out-of-State Dog Demographics</h3>
                <div class="observable-row">
                  <div class="observable-panel">
                    <h4 class="chart-subtitle">
                      State Dog Imports (Out-of-State Dogs Entering)
                    </h4>
                    <div id="observablehq-scatter_pies3-acc932e3"></div>
                  </div>
                  <div class="observable-panel">
                    <h4 class="chart-subtitle">
                      State Dog Exports (Dogs Leaving the State)
                    </h4>
                    <div id="observablehq-scatter_pies2-c7af2d76"></div>
                  </div>
                </div>

                <!-- In-state activity -->
                <h3 class="section-title">In-State Shelter Activity</h3>
                <div class="observable-row">
                  <div class="observable-panel">
                    <h4 class="chart-subtitle">
                      In-State Dogs per Organization
                    </h4>
                    <div id="observablehq-hist_instate_by_org-6a33d79e"></div>
                  </div>
                  <div class="observable-panel">
                    <h4 class="chart-subtitle">In-State Demographics</h4>
                    <div id="observablehq-scatter_pies4-c7af2d76"></div>
                  </div>
                </div>

                <!-- Raw records table -->
                <hr class="section-divider" />
                <h3 class="section-title">Raw Records (Interactive Table)</h3>
                <p class="text-muted mb-3">
                  The table below contains records of dog movement. For each
                  record, Found State shows where the dog originated, while the
                  Contact State will show where it moved to. Please note, some
                  dogs may have moved more than once. Please use the filters to
                  help guide your search.
                </p>
                <div id="state-table"></div>
              </div>
            </div>
          </section>

          <!-- Tableau section -->
          <section class="viz-section">
            <div class="section-banner">
              <h2>Overall State Movement (Tableau)</h2>
              <p>
                This Tableau view provides a high-level look at total dog
                movement by state, complementing the interactive analysis above.
              </p>
            </div>

            <div
              id="state-tableau-container"
              class="border rounded bg-light mb-4"
            >
              <p class="text-muted small mb-2">
                Tip: hover a state to see total movements; use the toolbar for
                basic interactions.
              </p>

              <div
                class="tableauPlaceholder"
                id="viz1763243454031"
                style="position: relative"
              >
                <noscript>
                  <a href="#">
                    <img
                      alt="Total Movement by State"
                      src="https://public.tableau.com/static/images/To/TotalMovementbyState/Sheet1/1_rss.png"
                      style="border: none"
                    />
                  </a>
                </noscript>
                <object class="tableauViz" style="display: none">
                  <param
                    name="host_url"
                    value="https%3A%2F%2Fpublic.tableau.com%2F"
                  />
                  <param name="embed_code_version" value="3" />
                  <param name="site_root" value="" />
                  <param
                    name="name"
                    value="TotalMovementbyState&#47;Sheet1"
                  />
                  <param name="tabs" value="no" />
                  <param name="toolbar" value="yes" />
                  <param
                    name="static_image"
                    value="https://public.tableau.com/static/images/To/TotalMovementbyState/Sheet1/1.png"
                  />
                  <param name="animate_transition" value="yes" />
                  <param name="display_static_image" value="yes" />
                  <param name="display_spinner" value="yes" />
                  <param name="display_overlay" value="yes" />
                  <param name="display_count" value="yes" />
                  <param name="language" value="en-US" />
                  <param name="filter" value="publish=yes" />
                </object>
              </div>
              <script type="text/javascript">
                var divElement =
                  document.getElementById("viz1763243454031");
                var vizElement =
                  divElement.getElementsByTagName("object")[0];
                vizElement.style.width = "100%";
                vizElement.style.height =
                  divElement.offsetWidth * 0.4 + "px";
                var scriptElement = document.createElement("script");
                scriptElement.src =
                  "https://public.tableau.com/javascripts/api/viz_v1.js";
                vizElement.parentNode.insertBefore(
                  scriptElement,
                  vizElement
                );
              </script>
            </div>
          </section>

          <!-- Observable wiring -->
          <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/@observablehq/inspector@5/dist/inspector.css"
          />
          <script type="module">
            import {
              Runtime,
              Inspector
            } from "https://cdn.jsdelivr.net/npm/@observablehq/runtime@5/dist/runtime.js";
            import define from "https://api.observablehq.com/d/a4c869afa6166459@533.js?v=4";

            new Runtime().module(define, (name) => {
              if (name === "viewof flowMode")
                return new Inspector(
                  document.querySelector(
                    "#observablehq-viewof-flowMode-6a33d79e"
                  )
                );
              if (name === "viewof state")
                return new Inspector(
                  document.querySelector(
                    "#observablehq-viewof-state-6a33d79e"
                  )
                );

              if (name === "partnerStatesOnly")
                return new Inspector(
                  document.querySelector(
                    "#observablehq-partnerStatesOnly-6a33d79e"
                  )
                );
              if (name === "flowMap")
                return new Inspector(
                  document.querySelector(
                    "#observablehq-flowMap-00c503e1"
                  )
                );

              if (name === "scatter_pies3")
                return new Inspector(
                  document.querySelector(
                    "#observablehq-scatter_pies3-acc932e3"
                  )
                );
              if (name === "scatter_pies2")
                return new Inspector(
                  document.querySelector(
                    "#observablehq-scatter_pies2-c7af2d76"
                  )
                );

              if (name === "hist_instate_by_org")
                return new Inspector(
                  document.querySelector(
                    "#observablehq-hist_instate_by_org-6a33d79e"
                  )
                );
              if (name === "scatter_pies4")
                return new Inspector(
                  document.querySelector(
                    "#observablehq-scatter_pies4-c7af2d76"
                  )
                );

              return [
                "dogTrips",
                "stateColor",
                "partnersData",
                "stateColorLegend",
                "partnerGeom"
              ].includes(name);
            });
          </script>
        </main>
      </div>
    </div>

    <!-- Bootstrap JS bundle via CDN -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>

    <!-- D3 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <script>
      // all_travel here is the Python list we passed in render_template
      window.all_travel = {{ all_travel | tojson }};
      window.instate_travel = {{ instate_travel | tojson }};
      window.outstate_travel = {{ outstate_travel | tojson }};
    </script>

    <!-- Your JS with d3TableWithControls/init logic -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
  </body>
</html>
